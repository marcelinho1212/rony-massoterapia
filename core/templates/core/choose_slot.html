{% extends "core/base.html" %}
{% block title %}Escolher horário{% endblock %}

{% block content %}
<div class="d-flex align-items-end justify-content-between mt-2 mb-3">
  <div>
    <h2 class="h4 fw-bold mb-1">Escolha o horário</h2>
    <div class="muted">
      Profissional: <span class="fw-semibold">{{ professional.name }}</span> •
      Serviço: <span class="fw-semibold">{{ service.name }}</span>
    </div>
  </div>
  <a href="{% url 'choose_service' professional.slug %}" class="btn btn-outline-secondary btn-sm btn-pill">Voltar</a>
</div>

<div class="row g-3 g-lg-4">
  <!-- COLUNA ESQUERDA: Dias -->
  <div class="col-12 col-lg-4">
    <div class="card card-soft">
      <div class="card-body p-4">
        <div class="fw-semibold mb-2">Selecione a data</div>
        <div class="list-group">
          {% for d in days %}
            {% with d_str=d|date:"Y-m-d" %}
              <a
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if selected_day == d_str %}active{% endif %}"
                href="?day={{ d_str }}"
              >
                <span>
                  <div class="fw-semibold">{{ d|date:"d/m" }}</div>
                  <div class="small {% if selected_day == d_str %}text-white-50{% else %}muted{% endif %}">
                    {{ d|date:"l" }}
                  </div>
                </span>
                <span class="badge {% if selected_day == d_str %}text-bg-light{% else %}text-bg-secondary{% endif %}">
                  {% if selected_day == d_str %}Selecionado{% else %}Ver{% endif %}
                </span>
              </a>
            {% endwith %}
          {% endfor %}
        </div>
        <div class="small muted mt-3">
          *Mostrando os próximos 7 dias.
        </div>
      </div>
    </div>
  </div>

  <!-- COLUNA DIREITA: Slots + Dados -->
  <div class="col-12 col-lg-8">
    <div class="card card-soft">
      <div class="card-body p-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
          <div>
            <div class="fw-semibold">Horários disponíveis</div>
            <div class="small muted">
              {% if selected_day %}
                Data selecionada: <span class="fw-semibold">{{ selected_day }}</span>
              {% else %}
                Selecione um dia para ver os horários.
              {% endif %}
            </div>
          </div>

          <span class="badge text-bg-light">
            Duração: {{ service.duration_minutes }} min
          </span>
        </div>

        {% if not selected_day %}
          <div class="alert alert-info mb-0">
            Escolha uma data na coluna ao lado para carregar os horários disponíveis.
          </div>
        {% else %}
          {% if slots %}

            <!-- Horários -->
            <div class="d-flex flex-wrap gap-2 mb-4" id="slotsWrap">
              {% for s in slots %}
                <button
                  type="button"
                  class="btn btn-outline-primary btn-pill"
                  data-slot="{{ s|date:'c' }}"
                  data-slot-label="{{ s|date:'d/m/Y H:i' }}"
                  onclick="selectSlot(this)"
                >
                  {{ s|date:"H:i" }}
                </button>
              {% endfor %}
            </div>

            <!-- FORM (sem modal dentro) -->
            <form id="bookingForm" method="post" action="{% url 'confirm_booking' %}" class="mt-2">
              {% csrf_token %}

              <input type="hidden" name="professional_slug" value="{{ professional.slug }}">
              <input type="hidden" name="service_id" value="{{ service.id }}">
              <input type="hidden" name="slot_iso" id="slotIso">

              <div class="card card-soft border-0" style="border-radius: 1rem;">
                <div class="card-body p-4">
                  <div class="fw-semibold mb-1">Seus dados</div>
                  <div class="small muted mb-3">
                    Horário selecionado:
                    <span class="fw-semibold" id="slotLabel">nenhum</span>
                  </div>

                  <div class="row g-3">
                    <div class="col-12 col-md-6">
                      <label class="form-label">Nome completo</label>
                      <input
                        type="text"
                        name="customer_name"
                        class="form-control"
                        placeholder="Ex.: João Silva"
                        required
                      >
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label">WhatsApp</label>
                      <input
                        type="text"
                        name="customer_whatsapp"
                        class="form-control"
                        placeholder="Ex.: (31) 99999-9999"
                        required
                      >
                      <div class="form-text">Informe um número válido com DDD.</div>
                    </div>
                  </div>

                  <div class="d-flex flex-wrap gap-2 mt-4">
                    <button
                      type="button"
                      class="btn btn-primary btn-lg btn-pill"
                      id="confirmBtn"
                      disabled
                      >
                      Confirmar agendamento
                    </button>

                    <a href="{% url 'choose_service' professional.slug %}" class="btn btn-outline-secondary btn-lg btn-pill">
                      Voltar
                    </a>
                  </div>
                </div>
              </div>
            </form>

            <!-- MODAL (fora do form) -->
            <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content card-soft" style="border-radius: 1rem;">
                  <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Quase pronto ✅</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                  </div>

                  <div class="modal-body pt-0">
                    <p class="mb-2">
                      Seu agendamento será registrado e você será redirecionado para o WhatsApp do profissional para enviar a mensagem.
                    </p>
                    <div class="small muted">
                      Profissional: <span class="fw-semibold">{{ professional.name }}</span><br>
                      Serviço: <span class="fw-semibold">{{ service.name }}</span><br>
                      Horário: <span class="fw-semibold" id="slotLabelModal">nenhum</span>
                    </div>
                  </div>

                  <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary btn-pill" data-bs-dismiss="modal">
                      Voltar
                    </button>

                    <button type="button" class="btn btn-primary btn-pill" id="finalSubmitBtn">
                      Ir para o WhatsApp
                    </button>
                  </div>
                </div>
              </div>
            </div>

          {% else %}
            <div class="alert alert-warning mb-0">
              Não há horários disponíveis para este dia. Selecione outra data.
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
<!--JAVASCRIPT-->
{% block extra_js %}
<script>
  function selectSlot(btn) {
    document.querySelectorAll('#slotsWrap button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const slotIso = btn.getAttribute('data-slot');
    const slotLabel = btn.getAttribute('data-slot-label');

    document.getElementById('slotIso').value = slotIso;
    document.getElementById('slotLabel').textContent = slotLabel;

    const modalLabel = document.getElementById('slotLabelModal');
    if (modalLabel) modalLabel.textContent = slotLabel;

    document.getElementById('confirmBtn').disabled = false;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("bookingForm");
    const confirmBtn = document.getElementById("confirmBtn");
    const finalBtn = document.getElementById("finalSubmitBtn");
    const modalEl = document.getElementById("confirmModal");

    // 1) Move o modal para o final do body (EVITA overlay/staking context)
    if (modalEl && modalEl.parentElement !== document.body) {
      document.body.appendChild(modalEl);
    }

    // 2) Cria o modal via JS (mais confiável que data-bs-*)
    let modal = null;
    if (modalEl && window.bootstrap) {
      modal = new bootstrap.Modal(modalEl, { backdrop: true, keyboard: true });
    }

    // Abre o modal ao clicar em "Confirmar agendamento"
    if (confirmBtn && modal) {
      confirmBtn.addEventListener("click", () => {
        // não abre se não tiver horário
        if (!document.getElementById("slotIso").value) return;
        modal.show();
      });
    }

    // Clique no botão do modal envia o form
    if (finalBtn && form) {
      finalBtn.addEventListener("click", () => {
        if (!document.getElementById("slotIso").value) return;
        // Fecha o modal antes de enviar (evita travas visuais)
        if (modal) modal.hide();

        // Envia
        form.requestSubmit ? form.requestSubmit() : form.submit();
      });
    }

    // máscara simples (31) 99999-9999
    const input = document.querySelector('input[name="customer_whatsapp"]');
    if (input) {
      input.addEventListener("input", () => {
        let v = input.value.replace(/\D/g, "").slice(0, 11);
        if (v.length >= 2) v = `(${v.slice(0,2)}) ` + v.slice(2);
        if (v.length >= 10) v = v.slice(0, 10) + "-" + v.slice(10);
        input.value = v;
      });
    }
  });
</script>
{% endblock %}
